# 0x04 后台实现

## 1. 登录、认证鉴权相关

**SSR 下执行环境不同带来的问题**：

需要注意：对于 SSR，页面**首次渲染**的环境**在“服务器端”，而不是“客户端”**（即便`router.tsx`放在客户端项目下，其`loader`函数执行是在服务端环境里），  
会有显著区别，比如没有`window`、`localStorage`等（这是两个主要的），  
对应存储的影响，没有`localStorage`、`sessionStorage`、`Cookies`。

因此对于鉴权，需要采用基于 cookie 的方式，将 JWT token 设置在 cookie 中。

**密码处理**：

因为 HTTPS，前端明文传输。  
后端 DB 存储`bcrypt.hash`后的密码，接口接收明文密码后`bcrypt.compare`与 hash 后的对比。

### (1) 登录登出

在`admin/login`（`AdminLoginPage`）页面，调用`authService.login`（这个是浏览器环境，在`auth.client.ts`中，因为是用户交互）。  
其调用服务端 API `/auth/login`，传`LoginDto`（账户密码）

服务端 controller 接收请求，从数据库查询用户，检验密码：

- 通过
  - `jwt.sign()`生成 JWT Token
    > JWT Token 由 header, payload, signature 组成，其中关键是 payload，会由中间件`auth.middleware.ts`中`koaJwt`通过`getToken()`解析，设置到`ctx.state.user`中。
  - JWT 写到 HttpOnly Cookie 中
  - 返回 user 信息
- 不通过：401

将 JWT Token 设置到 cookie 中，以后每次请求都将带上这个 token。

---

对于登出，则在`authService.logout`调用服务端的`logout`方法，其中把 cookie 对应的 JWT Token 设置为空。

### (2) 认证 (Authentication)

对于后端页面，都需要认证（登陆后才能访问），否则 403 到`admin/login`。

**实现方式 - 路由守卫**：

在`routes.tsx`中,`path:/admin`对应的`loader`函数中，添加登录守卫。

> React Router v6.4+ 官方推荐在 loader 中进行路由级**数据行为**，包括：权限检查、数据加载、重定向。

使用`requireAuth`方法进行认证，如果没登陆则`throw redirect('/admin/login')`进行登录，如果登陆了则返回用户信息（供后续页面消费）。  
`requireAuth`中会向`/auth/me`接口发送请求，如果登陆了则会带上 cookie，从而获取用户信息；没登陆则会被`apiFetch`给`throw Error`。

### (3) 鉴权 (Authorization)

_后续补充_

## 2. 页面、各 CRUD 功能的实现

包括：文章、分类、标签、用户的 CUD，以及仪表盘的显示。

1. 首先在前端添加基础 UI 组件，包括基于`react-md-editor`的编辑器组件。
2. 然后添加后台的 Layout 和 Page，包括：
   - `AdminLayout.tsx`：左右布局，包括五个页面，按照用户权限展示
     - `AdminDashboardPage`：仪表盘，只获取数据
     - `AdminPostPage`：文章列表，其中包含删除方法
     - `AdminPostEditPage`：文章编辑，其中主要用 React Router 的`<Form>`组件管理提交请求
     - `AdminCategoryPage`：分类，只有管理员能看到
     - `AdminTagPage`：标签，只有管理员能看到（其实与 Category 页面一样）
     - `AdminUserPage`：用户，只有管理员能看到，其中在编辑权限时，会发起请求获取用户（EDITOR 类型）的可编辑类别权限，然后展示对应项。

   其中都基于 React Router v7 的 loader，使用`useLoaderData`获取 router 中加载的 DTO 类型数据，使用`useFetcher`发起请求（`submit`）和获取状态（`idle`、`loading`、`submitting`）。

   > 拓展：`useFetcher`和`useNavigation`很类似，可以理解为两个不同的实例：
   >
   > - `useFetcher`：与`fetcher.submit`相关
   > - `useNavigation`：与`navigate`、`<Form>`相关

3. 前端中的 router 实现 loader 和 action、service 中增加相应服务
4. 后端中的增加相应 service、controller，添加到 api router 中

## 存疑

1. cookie 不会自动带上：按理来说设上`credentials: "include"`就会自动带上 cookie，但实际上并没有，目前是手动加的，以后搞明白一下。
