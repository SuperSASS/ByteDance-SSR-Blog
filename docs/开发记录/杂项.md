# 杂项

## 环境变量 .env 的坑

### 1. 只添加不覆盖

.env 只会添加没有的环境变量，**不会覆盖**。

所以有时候可能终端环境有问题，导致某变量的旧值一直存在，当更新后新值不会更新上去，出现问题。  
故重启终端即可。

### 2. ESM 中的加载顺序

传统的方法（`require('dotenv').config()`）， .env 都是同步加载的。  
而对于 ESM 模式的 node，其`import dotenv from 'dotenv';`，`dotenv.config();`是异步的。
也就是说，会出现“**还没加载环境变量就开始初始化**”的问题，对于依赖环境变量进行初始化的工作（数据库、JWT Secret等）造成严重影响。

如以下执行日记：

```sh
apps/server dev: undefined # 注：这里输出的是 process.env.JWT_SECRET
apps/server dev: [dotenv@17.2.3] injecting env (5) from ..\..\.env -- tip: 🔐 prevent building .env in docker: https://dotenvx.com/prebuild
```

可参考[技术随笔：Node.js ESM 中巧用 `-r dotenv/config` 解决环境变量异步加载问题](https://blog.csdn.net/zweizhao/article/details/153872837)，  
不在代码中异步加载，而是在`dev`脚本中使用`-r dotenv/config`，并通过`dotenv_config_path`指定路径。
