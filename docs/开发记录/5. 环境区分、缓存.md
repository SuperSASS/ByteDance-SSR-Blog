# 环境区分、缓存

对环境进行进一步规范和明确。

- `pnpm dev`：开发环境
- `pnpm start`：生产环境（本地）
- `pnpm build`：生产环境（部署）

## 开发环境

当使用`pnpm dev`时，此时不存在构建后的产物，都是源码，Vite 会做很多工作：

- 代码编译，使得在浏览器中可用
- **静态文件提供**（即编译后的 js css 产物）
- HMR

需要在 Koa 中使用 viteServer 客户端，详见[官方文档](https://vitejs.cn/vite3-cn/guide/ssr.html)。

首先在`app.ts`中，用`vite.createServer`创建一个 viteServer 客户端，然后挂载到 context 中供其它地方使用，然后加入中间件（注：官方文档用的`app.use(vite.middlewares)`对 Koa 不适用，这里要用`app.use(koaConnect(viteServer.middlewares));`）。

然后在`ssr.ts`中：

1. **`render`函数获取**：对于开发环境（存在 ViteServer），用`ctx.state.vite.ssrLoadModule('/src/entry-server.tsx')`的`render`函数。  
   ![1](<images/image-5. 开发生产环境.png>)
2. **`render`函数调用**，生成 appHtml  
   其中也可能是重定向等相应，此时`type = response`
3. **`html`生成**：
   先用`htmlTamplate`生成基础 HTML（不包含客户端脚本和 CSS），  
   然后再用`ctx.state.vite.transformIndexHtml(ctx.url, html)`注入客户端脚本  
   （此时存在 FOUC 问题，因为 CSS 还没有注入）
4. **设置 ETag 协商缓存**：对于 HTML（动态内容，可用 ETag 来进行“协商缓存”

   > 协商缓存，则是判断之前生成的内容与现在的内容是否有变化：
   >
   > - 如果没有，则只返回一个 304 状态，不返回内容，**优点：减少重复数据传输、节省流量、降低客户端渲染压力**
   > - 如果有，则返回新生成的页面
   >
   > 因此需要能基于内容比较页面是否变化，这里则为每个页面根据内容生成 ETag（Entity Tag，实体 ID），用于比较和标识。  
   > 同时带上'Cache-Control: no-cache'。让浏览器每次都询问服务器内容是否变化，而不是直接使用缓存。（这样才适用于动态内容）
   > ![与 Last-Modified 的区别](<images/image-5. 开发生产环境-1.png>)
   - 服务器端生成 ETag（实体 ID，唯一标识一个 HTML 页面，这里用`crypto.createHash('md5')`生成）
   - 客户端请求时，带上 If-None-Match
   - 服务器端比对 ETag，如果一致，则证明内容未变，返回 304 Not Modified；如果不一致，则返回

   注：Koa 实际上提供了协商缓存中间件（返回带上ETag的`koa-etag`、解析请求If-None-Match的`koa-conditional-get`），但这里手动实现。
