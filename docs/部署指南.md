# SSR Blog éƒ¨ç½²æŒ‡å—

æœ¬æŒ‡å—ä»‹ç»å¦‚ä½•å°†æ„å»ºåçš„ SSR Blog é¡¹ç›®éƒ¨ç½²åˆ°ç”Ÿäº§æœåŠ¡å™¨ï¼ˆå¦‚ WSLã€Linux æœåŠ¡å™¨ç­‰ï¼‰ã€‚

## ğŸ“‹ å‰ç½®è¦æ±‚

åœ¨æœåŠ¡å™¨ä¸Šéœ€è¦å®‰è£…ï¼š

- **Node.js** >= 18.x
- **pnpm** >= 8.x
- **SQLite3**ï¼ˆæˆ–å…¶ä»–æ•°æ®åº“ï¼‰

## ğŸ—ï¸ æ„å»ºæµç¨‹

### 1. æœ¬åœ°æ„å»º

åœ¨æœ¬åœ°å¼€å‘ç¯å¢ƒæ‰§è¡Œå®Œæ•´æ„å»ºï¼š

```bash
pnpm build
```

è¿™ä¼šç”Ÿæˆä»¥ä¸‹æ„å»ºäº§ç‰©ï¼š

- `packages/shared/dist/` - å…±äº«ç±»å‹å®šä¹‰å’Œ DTO
- `apps/server/dist/` - æœåŠ¡å™¨ç«¯ç¼–è¯‘åçš„ JavaScript
- `apps/web/dist/client/` - å®¢æˆ·ç«¯é™æ€èµ„æºï¼ˆHTMLã€CSSã€JSï¼‰
- `apps/web/dist/server/` - SSR æœåŠ¡å™¨ç«¯æ¸²æŸ“ä»£ç 

## ğŸ“¦ éƒ¨ç½²æ–¹æ¡ˆ

### æ–¹æ¡ˆä¸€ï¼šå®Œæ•´é¡¹ç›®éƒ¨ç½²ï¼ˆæ¨èï¼‰

å°†æ•´ä¸ªé¡¹ç›®ï¼ˆåŒ…æ‹¬æºç å’Œæ„å»ºäº§ç‰©ï¼‰éƒ¨ç½²åˆ°æœåŠ¡å™¨ã€‚

#### 1. å‡†å¤‡éƒ¨ç½²æ–‡ä»¶

éœ€è¦ä¸Šä¼ åˆ°æœåŠ¡å™¨çš„æ–‡ä»¶å’Œç›®å½•ï¼š

```
SSR-Blog/
â”œâ”€â”€ apps/
â”‚   â”œâ”€â”€ server/
â”‚   â”‚   â”œâ”€â”€ dist/          # âœ… å¿…éœ€
â”‚   â”‚   â””â”€â”€ package.json   # âœ… å¿…éœ€
â”‚   â””â”€â”€ web/
â”‚       â”œâ”€â”€ dist/          # âœ… å¿…éœ€
â”‚       â””â”€â”€ package.json   # âœ… å¿…éœ€
â”œâ”€â”€ packages/
â”‚   â””â”€â”€ shared/
â”‚       â”œâ”€â”€ dist/          # âœ… å¿…éœ€
â”‚       â””â”€â”€ package.json   # âœ… å¿…éœ€
â”œâ”€â”€ prisma/                # âœ… å¿…éœ€ï¼ˆæ•°æ®åº“ schemaï¼‰
â”œâ”€â”€ node_modules/          # âŒ ä¸éœ€è¦ï¼ˆæœåŠ¡å™¨ä¸Šé‡æ–°å®‰è£…ï¼‰
â”œâ”€â”€ package.json           # âœ… å¿…éœ€
â”œâ”€â”€ pnpm-lock.yaml         # âœ… å¿…éœ€
â”œâ”€â”€ pnpm-workspace.yaml    # âœ… å¿…éœ€
â”œâ”€â”€ .env                   # âœ… å¿…éœ€ï¼ˆç”Ÿäº§ç¯å¢ƒé…ç½®ï¼‰
â””â”€â”€ dev.db                 # âš ï¸ å¯é€‰ï¼ˆå¼€å‘æ•°æ®åº“ï¼Œç”Ÿäº§ç¯å¢ƒå»ºè®®æ–°å»ºï¼‰
```

#### 2. ä¸Šä¼ åˆ°æœåŠ¡å™¨

ä½¿ç”¨ `scp`ã€`rsync` æˆ– `git` ä¸Šä¼ ï¼š

**ä½¿ç”¨ rsyncï¼ˆæ¨èï¼‰ï¼š**

```bash
# ä» Windows ä¸Šä¼ åˆ° WSL
rsync -av --exclude='node_modules' \
  /mnt/f/Web\ Projects/SSR-Blog/ \
  /home/username/ssr-blog/

# æˆ–ä» Windows ä¸Šä¼ åˆ°è¿œç¨‹ Linux æœåŠ¡å™¨
rsync -av --exclude='node_modules' \
  -e ssh \
  F:\Web\ Projects\SSR-Blog/ \
  user@server:/home/username/ssr-blog/
```

**ä½¿ç”¨ Gitï¼ˆå¦‚æœä»£ç åœ¨ä»“åº“ä¸­ï¼‰ï¼š**

```bash
# åœ¨æœåŠ¡å™¨ä¸Š
git clone <your-repo-url> ssr-blog
cd ssr-blog
git checkout main  # æˆ–ä½ çš„ç”Ÿäº§åˆ†æ”¯
```

#### 3. æœåŠ¡å™¨ä¸Šå®‰è£…ä¾èµ–

```bash
cd ~/ssr-blog

# å®‰è£…ç”Ÿäº§ä¾èµ–
pnpm install --prod

# å¦‚æœéœ€è¦è¿è¡Œæ•°æ®åº“è¿ç§»
pnpm db:migration
```

#### 4. é…ç½®ç¯å¢ƒå˜é‡

åˆ›å»ºæˆ–ç¼–è¾‘ `.env` æ–‡ä»¶ï¼š

```bash
nano .env
```

ç”Ÿäº§ç¯å¢ƒé…ç½®ç¤ºä¾‹ï¼š

```env
# æœåŠ¡å™¨é…ç½®
NODE_ENV=production
PORT=3000
HOST=0.0.0.0

# æ•°æ®åº“é…ç½®
DATABASE_URL="file:./prod.db"

# JWT å¯†é’¥ï¼ˆè¯·ä½¿ç”¨å¼ºå¯†é’¥ï¼‰
JWT_SECRET=your-super-secret-jwt-key-change-this-in-production

# å…¶ä»–é…ç½®
LOG_LEVEL=info
```

#### 5. åˆå§‹åŒ–æ•°æ®åº“ï¼ˆå¦‚æœéœ€è¦ï¼‰

```bash
# ç”Ÿæˆ Prisma Client
pnpm db:client

# è¿è¡Œæ•°æ®åº“è¿ç§»
pnpm db:migration

# å¯é€‰ï¼šå¡«å……åˆå§‹æ•°æ®
pnpm db:reset
```

#### 6. å¯åŠ¨æœåŠ¡

**ç›´æ¥å¯åŠ¨ï¼š**

```bash
cd apps/server
pnpm start
```

**ä½¿ç”¨ PM2ï¼ˆæ¨èç”¨äºç”Ÿäº§ç¯å¢ƒï¼‰ï¼š**

é¦–å…ˆå®‰è£… PM2ï¼š

```bash
npm install -g pm2
```

åˆ›å»º PM2 é…ç½®æ–‡ä»¶ `ecosystem.config.cjs`ï¼š

```javascript
module.exports = {
  apps: [
    {
      name: 'ssr-blog',
      cwd: './apps/server',
      script: 'dist/app.js',
      instances: 'max', // ä½¿ç”¨æ‰€æœ‰ CPU æ ¸å¿ƒ
      exec_mode: 'cluster',
      env: {
        NODE_ENV: 'production',
        PORT: 3000,
      },
      error_file: './logs/err.log',
      out_file: './logs/out.log',
      log_date_format: 'YYYY-MM-DD HH:mm:ss Z',
      merge_logs: true,
      autorestart: true,
      watch: false,
      max_memory_restart: '1G',
    },
  ],
};
```

å¯åŠ¨æœåŠ¡ï¼š

```bash
# å¯åŠ¨
pm2 start ecosystem.config.cjs

# æŸ¥çœ‹çŠ¶æ€
pm2 status

# æŸ¥çœ‹æ—¥å¿—
pm2 logs ssr-blog

# è®¾ç½®å¼€æœºè‡ªå¯
pm2 startup
pm2 save
```

---

### æ–¹æ¡ˆäºŒï¼šä»…éƒ¨ç½²æ„å»ºäº§ç‰©ï¼ˆæœ€å°åŒ–éƒ¨ç½²ï¼‰

åªä¸Šä¼ å¿…éœ€çš„æ„å»ºäº§ç‰©å’Œä¾èµ–ï¼Œä¸åŒ…å«æºç ã€‚

#### 1. åˆ›å»ºéƒ¨ç½²ç›®å½•ç»“æ„

åœ¨æœ¬åœ°åˆ›å»ºä¸€ä¸ªä¸´æ—¶éƒ¨ç½²ç›®å½•ï¼š

```bash
mkdir deploy
cd deploy

# å¤åˆ¶å¿…éœ€æ–‡ä»¶
cp -r ../apps/server/dist server
cp -r ../apps/web/dist web
cp -r ../packages/shared/dist shared
cp -r ../prisma prisma
cp ../package.json .
cp ../pnpm-lock.yaml .
cp ../pnpm-workspace.yaml .
cp ../.env.production .env
```

#### 2. åˆ›å»ºç®€åŒ–çš„ package.json

åœ¨ `deploy/` ç›®å½•åˆ›å»ºç”Ÿäº§ç”¨çš„ `package.json`ï¼š

```json
{
  "name": "ssr-blog-production",
  "version": "1.0.0",
  "type": "module",
  "scripts": {
    "start": "node server/app.js"
  },
  "dependencies": {
    "@koa/router": "^14.0.0",
    "@prisma/client": "^7.0.1",
    "bcryptjs": "^3.0.3",
    "dotenv": "^17.2.3",
    "jsonwebtoken": "^9.0.2",
    "koa": "^3.1.1",
    "koa-bodyparser": "^4.4.1",
    "koa-connect": "^2.1.0",
    "koa-jwt": "^4.0.4",
    "koa-logger": "^4.0.0",
    "koa-mount": "^4.2.0",
    "koa-static": "^5.0.0",
    "react": "^19.2.0",
    "winston": "^3.18.3"
  }
}
```

#### 3. ä¸Šä¼ å¹¶å¯åŠ¨

```bash
# ä¸Šä¼ åˆ°æœåŠ¡å™¨
rsync -av deploy/ user@server:/var/www/ssr-blog/

# åœ¨æœåŠ¡å™¨ä¸Š
cd /var/www/ssr-blog
pnpm install --prod
pnpm start
```

---

## ğŸ”§ Nginx åå‘ä»£ç†é…ç½®ï¼ˆå¯é€‰ï¼‰

å¦‚æœä½¿ç”¨ Nginx ä½œä¸ºåå‘ä»£ç†ï¼š

```nginx
server {
    listen 80;
    server_name yourdomain.com;

    # é™æ€èµ„æºç›´æ¥ç”± Nginx æä¾›
    location /assets/ {
        alias /home/username/ssr-blog/apps/web/dist/client/assets/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # API å’Œ SSR è¯·æ±‚è½¬å‘åˆ° Node.js
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}
```

å¯ç”¨é…ç½®ï¼š

```bash
sudo ln -s /etc/nginx/sites-available/ssr-blog /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

---

## ğŸ” éªŒè¯éƒ¨ç½²

è®¿é—®æœåŠ¡å™¨ï¼š

```bash
# æœ¬åœ°æµ‹è¯•
curl http://localhost:3000

# è¿œç¨‹æµ‹è¯•
curl http://your-server-ip:3000
```

æ£€æŸ¥æœåŠ¡çŠ¶æ€ï¼š

```bash
# ä½¿ç”¨ PM2
pm2 status
pm2 logs ssr-blog

# æˆ–ç›´æ¥æŸ¥çœ‹è¿›ç¨‹
ps aux | grep node
```

---

## ğŸ“ å¸¸è§é—®é¢˜

### 1. ç«¯å£è¢«å ç”¨

```bash
# æŸ¥æ‰¾å ç”¨ç«¯å£çš„è¿›ç¨‹
lsof -i :3000
# æˆ–
netstat -tulpn | grep 3000

# æ€æ­»è¿›ç¨‹
kill -9 <PID>
```

### 2. æ•°æ®åº“è¿æ¥é”™è¯¯

- æ£€æŸ¥ `.env` ä¸­çš„ `DATABASE_URL` æ˜¯å¦æ­£ç¡®
- ç¡®ä¿æ•°æ®åº“æ–‡ä»¶æœ‰æ­£ç¡®çš„è¯»å†™æƒé™
- è¿è¡Œ `pnpm db:client` é‡æ–°ç”Ÿæˆ Prisma Client

### 3. é™æ€èµ„æº 404

- ç¡®ä¿ `apps/web/dist/client/` ç›®å½•å·²æ­£ç¡®ä¸Šä¼ 
- æ£€æŸ¥ Koa Static ä¸­é—´ä»¶é…ç½®
- æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—ç¡®è®¤é™æ€æ–‡ä»¶è·¯å¾„

### 4. ç¯å¢ƒå˜é‡æœªç”Ÿæ•ˆ

- ç¡®ä¿ `.env` æ–‡ä»¶åœ¨é¡¹ç›®æ ¹ç›®å½•
- ä½¿ç”¨ PM2 æ—¶ï¼Œåœ¨ `ecosystem.config.cjs` ä¸­é…ç½®ç¯å¢ƒå˜é‡
- é‡å¯æœåŠ¡åç”Ÿæ•ˆ

---

## ğŸš€ è‡ªåŠ¨åŒ–éƒ¨ç½²ï¼ˆè¿›é˜¶ï¼‰

å¯ä»¥åˆ›å»ºéƒ¨ç½²è„šæœ¬ `scripts/deploy.sh`ï¼š

```bash
#!/bin/bash

echo "ğŸš€ å¼€å§‹éƒ¨ç½² SSR Blog..."

# 1. æœ¬åœ°æ„å»º
echo "ğŸ“¦ æ„å»ºé¡¹ç›®..."
pnpm build

# 2. ä¸Šä¼ åˆ°æœåŠ¡å™¨
echo "ğŸ“¤ ä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨..."
rsync -av --exclude='node_modules' \
  --exclude='.git' \
  --exclude='*.log' \
  ./ user@server:/home/username/ssr-blog/

# 3. åœ¨æœåŠ¡å™¨ä¸Šå®‰è£…ä¾èµ–å¹¶é‡å¯
echo "ğŸ”„ åœ¨æœåŠ¡å™¨ä¸Šå®‰è£…ä¾èµ–å¹¶é‡å¯æœåŠ¡..."
ssh user@server << 'EOF'
  cd ~/ssr-blog
  pnpm install --prod
  pm2 restart ssr-blog
EOF

echo "âœ… éƒ¨ç½²å®Œæˆï¼"
```

ä½¿ç”¨ï¼š

```bash
chmod +x scripts/deploy.sh
./scripts/deploy.sh
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å¼€å‘é˜¶æ®µå®‰æ’](./å¼€å‘é˜¶æ®µå®‰æ’.md)
- [é¡¹ç›®è§„åˆ’](./é¡¹ç›®è§„åˆ’.md)
- [PM2 å®˜æ–¹æ–‡æ¡£](https://pm2.keymetrics.io/)
- [Nginx å®˜æ–¹æ–‡æ¡£](https://nginx.org/en/docs/)
